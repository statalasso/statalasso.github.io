<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.11.1 by Michael Rose
  Copyright 2013-2018 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE.txt
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Cross-validation with cvlasso - The Stata Lasso Page</title>
<meta name="description" content="The Stata Lasso Page.">



<meta property="og:type" content="website">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="The Stata Lasso Page">
<meta property="og:title" content="Cross-validation with cvlasso">
<meta property="og:url" content="http://localhost:4000/docs/cvlasso/">












  

  


<link rel="canonical" href="http://localhost:4000/docs/cvlasso/">







  <script type="application/ld+json">
    {
      "@context": "http://schema.org",
      "@type": "Person",
      "name": "Achim Ahrens",
      "url": "http://localhost:4000",
      "sameAs": null
    }
  </script>







<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="The Stata Lasso Page Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if lte IE 9]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->


    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    <div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        <a class="site-title" href="/">The Stata Lasso Page</a>
        <ul class="visible-links">
          
            
            <li class="masthead__menu-item">
              <a href="http://localhost:4000/" >Home</a>
            </li>
          
            
            <li class="masthead__menu-item">
              <a href="http://localhost:4000/installation/" >Installation</a>
            </li>
          
            
            <li class="masthead__menu-item">
              <a href="http://localhost:4000/slides/" >Slides</a>
            </li>
          
            
            <li class="masthead__menu-item">
              <a href="http://localhost:4000/about/" >About</a>
            </li>
          
            
            <li class="masthead__menu-item">
              <a href="http://localhost:4000/references/" >References</a>
            </li>
          
        </ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle Menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>

    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  
  
    
      
      
      
    
    
      

<nav class="nav__list">
  
  <input id="ac-toc" name="accordion-toc" type="checkbox" />
  <label for="ac-toc">Toggle Menu</label>
  <ul class="nav__items">
    
      <li>
        
          <span class="nav__sub-title">lassopack</span>
        

        
        <ul>
          
            
            

            
            

            <li><a href="/docs/lassopack/" class="">Overview</a></li>
          
            
            

            
            

            <li><a href="/docs/regularized_reg/" class="">Regularized regression</a></li>
          
            
            

            
            

            <li><a href="/docs/estimators/" class="">Estimation methods</a></li>
          
            
            

            
            

            <li><a href="/docs/lasso2/" class="">Getting started (lasso2)</a></li>
          
            
            

            
            

            <li><a href="/docs/cvlasso/" class="active">Cross-validation (cvlasso)</a></li>
          
            
            

            
            

            <li><a href="/docs/rlasso/" class="">Rigorous lasso (rlasso)</a></li>
          
            
            

            
            

            <li><a href="/docs/lasso2_help/" class="">Help lasso2</a></li>
          
            
            

            
            

            <li><a href="/docs/cvlasso_help/" class="">Help cvlasso</a></li>
          
            
            

            
            

            <li><a href="/docs/rlasso_help/" class="">Help rlasso</a></li>
          
            
            

            
            

            <li><a href="/docs/lassopack_cite/" class="">Citation</a></li>
          
        </ul>
        
      </li>
    
      <li>
        
          <span class="nav__sub-title">pdslasso</span>
        

        
        <ul>
          
            
            

            
            

            <li><a href="/docs/pdslasso/" class="">Overview</a></li>
          
            
            

            
            

            <li><a href="/docs/pdslasso_models/" class="">Models</a></li>
          
            
            

            
            

            <li><a href="/docs/pdslasso_demo/" class="">Demonstration</a></li>
          
            
            

            
            

            <li><a href="/docs/ivlasso_help/" class="">Help file</a></li>
          
            
            

            
            

            <li><a href="/docs/pdslasso_cite/" class="">Citation</a></li>
          
        </ul>
        
      </li>
    
  </ul>
</nav>
    
  
  </div>


  <article class="page" itemscope itemtype="http://schema.org/CreativeWork">
    <meta itemprop="headline" content="Cross-validation with cvlasso">
    
    
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Cross-validation with cvlasso
</h1>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> On This Page</h4></header>
              <ul class="toc__menu">
  <li><a href="#k-fold-cross-validation">K-fold cross-validation</a></li>
  <li><a href="#estimate-the-selected-model">Estimate the selected model</a></li>
  <li><a href="#k-fold-cross-validation-over-lambda-and-alpha">K-fold cross-validation over lambda and alpha</a></li>
  <li><a href="#plotting">Plotting</a></li>
  <li><a href="#prediction">Prediction</a></li>
  <li><a href="#store-intermediate-steps">Store intermediate steps</a></li>
</ul>
            </nav>
          </aside>
        
        <script type="text/javascript" async="" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
</script>

<p>In the course of cross-validation, the data is repeatedly partitioned into training
and validation data. The model is fit to the training data and the validation data is
used to calculate the prediction error.
This in turn enables us to identify the values of <script type="math/tex">\lambda</script> and <script type="math/tex">\alpha</script>
that optimize predictive performance (i.e., minimize the estimated mean-squared prediction error).</p>

<p><code class="highlighter-rouge">cvlasso</code> supports <script type="math/tex">K</script>-fold cross-validation and <script type="math/tex">h</script>-step ahead rolling cross-validation. 
The latter is intended for time-series or panel data with a large time dimension. 
<script type="math/tex">h</script>-step ahead rolling cross-validation was suggested by 
<a href="https://robjhyndman.com/hyndsight/tscv/">Rob H Hyndman in a blog post</a>.</p>

<h3 id="k-fold-cross-validation">K-fold cross-validation</h3>

<p>We begin with 10-fold cross-validation (the default). 
If no fold variable is specified (which can be done using the <code class="highlighter-rouge">foldvar()</code> option),
the data is randomly partitioned into “folds”.</p>

<p>We use <code class="highlighter-rouge">seed(123)</code> throughout this demonstration to allow 
reproducing the outputs below.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>. cvlasso lpsa lcavol lweight age lbph svi lcp gleason pgg45, ///
          seed(123)

K-fold cross-validation with 10 folds. Elastic net with alpha=1.
Fold 1 2 3 4 5 6 7 8 9 10 
	  |         Lambda           MSPE       st. dev.
----------+---------------------------------------------
	 1|      163.62492      1.3162136      .13064798 
	 2|      149.08894      1.2141972      .12282686 
	 3|      135.84429       1.114079      .11387635
...
	17|      36.930468       .5827423      .06260056  ^ 
... 
	27|      14.566138      .53408884      .05830419  *
... 
       100|      .01636249      .54838029      .07390164 
* lopt = the lambda that minimizes MSPE.
  Run model: cvlasso, lopt
^ lse = largest lambda for which MSPE is within one standard error of the minimal MSPE.
  Run model: cvlasso, lse
</code></pre></div></div>

<p>Note that parts of the output have been omitted for the sake of brevity. The columns 2 to 4 show
the value of <script type="math/tex">\lambda</script>, the estimate of the mean-squared prediction error and the associated standard error.</p>

<p>The <script type="math/tex">\lambda</script> value that minimizes the mean-squared prediction error is indicated by an asterisk (<code class="highlighter-rouge">*</code>). 
A hat (<code class="highlighter-rouge">^</code>) marks the largest <script type="math/tex">\lambda</script> at which the MSPE is within one standard error of the minimal MSPE.
We denote these by <script type="math/tex">\lambda_{lopt}</script> and <script type="math/tex">\lambda_{lse}</script>, respectively. The former is returned in <code class="highlighter-rouge">e(lopt)</code>, the latter in <code class="highlighter-rouge">e(lse)</code>.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>. di e(lopt)
14.566138

. di e(lse)
36.930468
</code></pre></div></div>

<h3 id="estimate-the-selected-model">Estimate the selected model</h3>

<p>To estimate the full model with either <script type="math/tex">\lambda_{lopt}</script> or <script type="math/tex">\lambda_{lse}</script>, we can 
use <code class="highlighter-rouge">lopt</code> or <code class="highlighter-rouge">lse</code>.
Internally, <code class="highlighter-rouge">cvlasso</code> calls <code class="highlighter-rouge">lasso2</code> with either <code class="highlighter-rouge">lambda(14.566138)</code> or <code class="highlighter-rouge">lambda(36.930468)</code>.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>. cvlasso lpsa lcavol lweight age lbph svi lcp gleason pgg45, ///
          lopt seed(123)
. cvlasso lpsa lcavol lweight age lbph svi lcp gleason pgg45, ///
          lse seed(123)
</code></pre></div></div>

<p>The same as above can be achieved using the replay syntax in two steps.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>. cvlasso lpsa lcavol lweight age lbph svi lcp gleason pgg45, ///
          seed(123)
. cvlasso, lopt
. cvlasso, lse
</code></pre></div></div>

<p>If <code class="highlighter-rouge">postest</code> is specified, <code class="highlighter-rouge">cvlasso</code> posts the <code class="highlighter-rouge">lasso2</code> estimation results.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>. cvlasso, lopt postest
. ereturn list
</code></pre></div></div>

<h3 id="k-fold-cross-validation-over-lambda-and-alpha">K-fold cross-validation over lambda and alpha</h3>

<p><code class="highlighter-rouge">alpha()</code> can be a scalar or list of elastic net parameters.  Each <script type="math/tex">\alpha</script> value must lie
in the interval [0,1].  If <code class="highlighter-rouge">alpha()</code> is a list longer than one, <code class="highlighter-rouge">cvlasso</code> cross-validates
over <script type="math/tex">\lambda</script> <em>and</em> <script type="math/tex">\alpha</script>.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>. cvlasso lpsa lcavol lweight age lbph svi lcp gleason pgg45, ///
          alpha(0 0.1 0.5 1) seed(123)

Cross-validation over alpha (0 .1 .5 1).
	 alpha | lopt*        Minimum MSPE
   ------------+----------------------------
	 0.000 | 12.093063    .54348993
	 0.100 | 25.454739     .5418149
	 0.500 | 15.986318    .53499607
	 1.000 | 14.566138    .53408884  #
* lambda value that minimizes MSPE for a given alpha
# alpha value that minimizes MSPE
</code></pre></div></div>

<p>The second column in the table indicates the value of <script type="math/tex">\lambda</script> that minimizes 
the MSPE for a given value of <script type="math/tex">\alpha</script>. A hash key (<code class="highlighter-rouge">#</code>) indicates that value of <script type="math/tex">\alpha</script>
that minimizes the overall MSPE.</p>

<h3 id="plotting">Plotting</h3>

<p>We can plot the estimated mean-squared prediction error over <script type="math/tex">\lambda</script>.  Note that the
plotting feature is not supported if we also cross-validate over <script type="math/tex">\alpha</script>.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>. cvlasso lpsa lcavol lweight age lbph svi lcp gleason pgg45, ///
          seed(123) plotcv
</code></pre></div></div>

<p>This produces the following graph:</p>

<p><img src="/_img/cvlasso.png" alt="" height="100%" width="100%" /></p>

<p>The two vertical lines indicate <script type="math/tex">\lambda_{lopt}</script> and <script type="math/tex">\lambda_{lse}</script> (dashed line).</p>

<p>Similar to <code class="highlighter-rouge">lasso2</code>, <code class="highlighter-rouge">cvlasso</code> allows to pass plotting options on to Stata’s <code class="highlighter-rouge">line</code>
using <code class="highlighter-rouge">plotopt()</code>.</p>

<h3 id="prediction">Prediction</h3>

<p>The predict postestimation command allows to obtain predicted values and residuals
for either <code class="highlighter-rouge">e(lopt)</code> or <code class="highlighter-rouge">e(lse)</code>.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>. cvlasso lpsa lcavol lweight age lbph svi lcp gleason pgg45, ///
          seed(123)
. cap drop xbhat1
. predict double xbhat1, lopt

. cvlasso lpsa lcavol lweight age lbph svi lcp gleason pgg45, ///
          seed(123)
. cap drop xbhat2
. predict double xbhat2, lse
</code></pre></div></div>

<h3 id="store-intermediate-steps">Store intermediate steps</h3>

<p><code class="highlighter-rouge">cvlasso</code> calls <code class="highlighter-rouge">lasso2</code> internally.  The <code class="highlighter-rouge">saveest(string)</code> allows to 
access intermediate estimation results.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>. cvlasso lpsa lcavol lweight age lbph svi lcp gleason pgg45, ///
	  seed(123) nfolds(3) saveest(step)
. estimates dir
. estimates restore step1
. estimates replay step1
</code></pre></div></div>

<p><em>Note:</em> EBIC and <script type="math/tex">R^2</script> are not calculated to speed up the computation.</p>

<h2 id="time-series-example-using-rolling-h-step-ahead-cross-validation">Time-series example using rolling h-step ahead cross-validation</h2>

<p>Load airline passenger data:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>. webuse air2, clear
</code></pre></div></div>

<p>There are 144 observations in the sample.  <code class="highlighter-rouge">origin()</code> controls the sample range used
for training and validation.  In this example, <code class="highlighter-rouge">origin(130)</code> implies that data up to
and including <script type="math/tex">t=130</script> are used for training in the first iteration.  Data points <script type="math/tex">t=131,...,144</script>
 are successively used for validation.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>. cvlasso air L(1/12).air, rolling origin(130)
Rolling forecasting cross-validation with 1-step ahead forecasts. Elastic net with alpha=1.
Training from-to (validation point): 13-130 (131), 13-131 (132), 13-132 (133), 13-133 (134),
&gt; 13-134 (135), 13-135 (136), 13-136 (137), 13-137 (138), 13-138 (139), 13-139 (140), 
&gt; 13-140 (141), 13-141 (142), 13-142 (143), 13-143 (144).
</code></pre></div></div>

<p>The notation <code class="highlighter-rouge">a-b (v)</code> indicates that
data <code class="highlighter-rouge">a</code> to <code class="highlighter-rouge">b</code> are used for estimation (training), and data point <code class="highlighter-rouge">v</code> is used for
forecasting (validation).  Note that the training dataset starts with <script type="math/tex">t=13</script> since 12
lags are used as predictors.</p>

<p>The “optimal” model includes lags 1, 11 and 12.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>. cvlasso, lopt
Estimate lasso with lambda=315.16 (lopt).

---------------------------------------------------
	 Selected |           Lasso   Post-est OLS
------------------+--------------------------------
	      air |
	      L1. |       0.1534004      0.1610229
	     L11. |       0.0638066      0.0724006
	     L12. |       0.8422566      0.8374074
------------------+--------------------------------
   Partialled-out*|
------------------+--------------------------------
	          |
	    _cons |      11.5075093      8.2797832
---------------------------------------------------
</code></pre></div></div>

<p>The option <code class="highlighter-rouge">h()</code> controls the forecasting horizon (default is <code class="highlighter-rouge">h(1)</code>).</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>. cvlasso air L(1/12).air, rolling origin(130) h(2)
Rolling forecasting cross-validation with 2-step ahead forecasts. Elastic net with alpha=1.
Training from-to (validation point): 13-130 (132), 13-131 (133), 13-132 (134), 13-133 (135),
&gt; 13-134 (136), 13-135 (137), 13-136 (138), 13-137 (139), 13-138 (140), 13-139 (141), 
&gt; 13-140 (142), 13-141 (143), 13-142 (144).
</code></pre></div></div>

<p>In the above examples, the size of the training dataset increases by one data point
each step.  To keep the size of the training dataset fixed, specify <code class="highlighter-rouge">fixedwindow</code>.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>. cvlasso air L(1/12).air, rolling origin(130) fixedwindow
Rolling forecasting cross-validation with 1-step ahead forecasts. Elastic net with alpha=1.
Training from-to (validation point): 13-130 (131), 14-131 (132), 15-132 (133), 16-133 (134),
&gt; 17-134 (135), 18-135 (136), 19-136 (137), 20-137 (138), 21-138 (139), 22-139 (140), 
&gt; 23-140 (141), 24-141 (142), 25-142 (143), 26-143 (144).
</code></pre></div></div>

<h2 id="panel-data-example-using-rolling-h-step-ahead-cross-validation">Panel data example using rolling h-step ahead cross-validation</h2>

<p>Rolling cross-validation can also be applied to panel data.  For demonstration, load
Grunfeld data.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>. webuse grunfeld, clear
</code></pre></div></div>

<p>Apply 1-step ahead cross-validation.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>. cvlasso mvalue L(1/10).mvalue, rolling origin(1950)
Rolling forecasting cross-validation with 1-step ahead forecasts. Elastic net with alpha=1.
Training from-to (validation point): 1945-1950 (1951), 1945-1951 (1952), 1945-1952 (1953), 
&gt; 1945-1953 (1954).
</code></pre></div></div>

<p>The model selected by cross-validation:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>. cvlasso, lopt
Estimate lasso with lambda=4828.76 (lopt).

---------------------------------------------------
	 Selected |           Lasso   Post-est OLS
------------------+--------------------------------
	   mvalue |
	      L1. |       0.7289970      0.7343915
	      L5. |       0.1181815      0.1239170
	      L7. |       0.0027785      0.0062233
	      L8. |       0.0613727      0.0647928
	      L9. |       0.1014168      0.1031103
------------------+--------------------------------
   Partialled-out*|
------------------+--------------------------------
	          |
	    _cons |      42.6792365     21.8393696
---------------------------------------------------
</code></pre></div></div>

<h2 id="more">More</h2>

<p>Please check the help file for more information and examples.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>. help cvlasso
</code></pre></div></div>


        
      </section>

      <footer class="page__meta">
        
        


        
      </footer>

      

      
    </div>

    
  </article>

  
  
</div>
    </div>

    

    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    
    
    
    
    
    
    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2018 Achim Ahrens. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script src="https://use.fontawesome.com/releases/v5.0.9/js/all.js"></script>








  </body>
</html>